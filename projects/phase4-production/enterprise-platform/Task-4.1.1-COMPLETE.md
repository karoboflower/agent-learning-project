# Task 4.1.1 å®Œæˆ - å¾®æœåŠ¡æ¶æ„è®¾è®¡

**å®Œæˆæ—¥æœŸ**: 2026-01-30
**ä»»åŠ¡**: è®¾è®¡å¾®æœåŠ¡æ¶æ„ï¼ˆDay 1-2ï¼‰

---

## âœ… å®Œæˆå†…å®¹

### 1. æ¶æ„æ–‡æ¡£ âœ…

**æ–‡ä»¶**: `docs/architecture/microservices.md` (~900è¡Œ)

**åŒ…å«å†…å®¹**:
- âœ… æ¶æ„æ¦‚è¿°ï¼ˆè®¾è®¡åŸåˆ™ã€æŠ€æœ¯æ ˆã€æ¶æ„å›¾ï¼‰
- âœ… 7ä¸ªå¾®æœåŠ¡è¯¦ç»†è®¾è®¡
- âœ… æœåŠ¡é€šä¿¡æœºåˆ¶ï¼ˆgRPC + æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- âœ… æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡
- âœ… æ•°æ®æ¶æ„è®¾è®¡
- âœ… éƒ¨ç½²æ¶æ„ï¼ˆKubernetesï¼‰
- âœ… å®‰å…¨æ¶æ„ï¼ˆè®¤è¯ã€æˆæƒã€åŠ å¯†ï¼‰
- âœ… å¯è§‚æµ‹æ€§æ¶æ„ï¼ˆç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ªï¼‰
- âœ… ç³»ç»Ÿå®¹é‡è§„åˆ’
- âœ… ç¾éš¾æ¢å¤æ–¹æ¡ˆ

### 2. gRPCåè®®å®šä¹‰ âœ…

**ç›®å½•**: `architecture/proto/`

**æ–‡ä»¶åˆ—è¡¨**:
- âœ… `agent.proto` - Agentæœï¿½ï¿½åè®®ï¼ˆæµå¼å“åº”ã€ä¸Šä¸‹æ–‡ç®¡ç†ï¼‰
- âœ… `task.proto` - ä»»åŠ¡æœåŠ¡åè®®ï¼ˆä»»åŠ¡é˜Ÿåˆ—ã€çŠ¶æ€ç®¡ç†ï¼‰
- âœ… `tenant.proto` - ç§Ÿæˆ·æœåŠ¡åè®®ï¼ˆé…é¢ç®¡ç†ã€æ•°æ®éš”ç¦»ï¼‰

**åè®®ç‰¹ç‚¹**:
- ä½¿ç”¨Protocol Buffers v3
- æ”¯æŒæµå¼å“åº”ï¼ˆServer Streamingï¼‰
- å®Œæ•´çš„è¯·æ±‚/å“åº”æ¶ˆæ¯å®šä¹‰
- æšä¸¾ç±»å‹å®šä¹‰ï¼ˆçŠ¶æ€ã€ä¼˜å…ˆçº§ç­‰ï¼‰
- å…ƒæ•°æ®å’Œæ—¶é—´æˆ³æ”¯æŒ

### 3. é¡¹ç›®ç»“æ„è®¾è®¡ âœ…

**æ–‡ä»¶**: `architecture/PROJECT_STRUCTURE.md` (~450è¡Œ)

**å†…å®¹**:
- âœ… å®Œæ•´çš„ç›®å½•ç»“æ„ï¼ˆ7ä¸ªæœåŠ¡ + å…±äº«åº“ + éƒ¨ç½²é…ç½®ï¼‰
- âœ… æ¯ä¸ªæœåŠ¡çš„æ ‡å‡†ç»“æ„ï¼ˆcmd/internal/proto/config/migrationsï¼‰
- âœ… å…±äº«åº“åˆ’åˆ†ï¼ˆlogger/tracing/metrics/middlewareï¼‰
- âœ… éƒ¨ç½²é…ç½®ï¼ˆKubernetes/Docker Compose/Helm/Terraformï¼‰
- âœ… ç›‘æ§é…ç½®ï¼ˆPrometheus/Grafana/Jaegerï¼‰
- âœ… æ—¥å¿—é…ç½®ï¼ˆELK Stackï¼‰
- âœ… å¼€å‘æµç¨‹è¯´æ˜
- âœ… æŠ€æœ¯æ ˆç‰ˆæœ¬æ¸…å•

### 4. Makefile âœ…

**æ–‡ä»¶**: `Makefile` (~240è¡Œ)

**åŠŸèƒ½å‘½ä»¤**:
- âœ… `make proto-gen` - ç”ŸæˆgRPCä»£ç 
- âœ… `make build` - ç¼–è¯‘æ‰€æœ‰æœåŠ¡
- âœ… `make test` - è¿è¡Œæµ‹è¯•
- âœ… `make docker-build` - æ„å»ºDockeré•œåƒ
- âœ… `make docker-push` - æ¨é€é•œåƒ
- âœ… `make k8s-deploy` - éƒ¨ç½²åˆ°Kubernetes
- âœ… `make dev-up` - å¯åŠ¨å¼€å‘ç¯å¢ƒ
- âœ… `make dev-down` - åœæ­¢å¼€å‘ç¯å¢ƒ
- âœ… `make migrate-up/down` - æ•°æ®åº“è¿ç§»
- âœ… `make fmt/lint` - ä»£ç æ ¼å¼åŒ–å’Œæ£€æŸ¥
- âœ… `make docs-gen` - ç”ŸæˆAPIæ–‡æ¡£

### 5. Docker Composeå¼€å‘ç¯å¢ƒ âœ…

**æ–‡ä»¶**: `deploy/docker-compose/docker-compose.dev.yml` (~350è¡Œ)

**åŒ…å«æœåŠ¡**:

**åŸºç¡€è®¾æ–½**:
- âœ… PostgreSQL 15 - æ•°æ®åº“
- âœ… Redis 7 - ç¼“å­˜
- âœ… Consul 1.17 - æœåŠ¡å‘ç°
- âœ… NATS 2.10 - æ¶ˆæ¯é˜Ÿåˆ—

**ç›‘æ§æ ˆ**:
- âœ… Prometheus 2.48 - æŒ‡æ ‡æ”¶é›†
- âœ… Grafana 10.2 - å¯è§†åŒ–é¢æ¿
- âœ… Jaeger 1.52 - åˆ†å¸ƒå¼è¿½è¸ª

**æ—¥å¿—æ ˆ**:
- âœ… Elasticsearch 8.11 - æ—¥å¿—å­˜å‚¨
- âœ… Kibana 8.11 - æ—¥å¿—å¯è§†åŒ–
- âœ… Logstash 8.11 - æ—¥å¿—å¤„ç†

**å¾®æœåŠ¡**ï¼ˆ7ä¸ªï¼‰:
- âœ… Agent Service (8081, 9081)
- âœ… Task Service (8082, 9082)
- âœ… Tool Service (8083, 9083)
- âœ… User Service (8084, 9084)
- âœ… Tenant Service (8085, 9085)
- âœ… Cost Service (8086, 9086)
- âœ… Monitoring Service (8087, 9087)

**ç‰¹æ€§**:
- âœ… å¥åº·æ£€æŸ¥é…ç½®
- âœ… å·æŒä¹…åŒ–
- âœ… ç½‘ç»œéš”ç¦»
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… ä¾èµ–å…³ç³»ç®¡ç†

### 6. æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ âœ…

**æ–‡ä»¶**: `deploy/docker-compose/init-db.sql`

**åŠŸèƒ½**:
- âœ… åˆ›å»º7ä¸ªç‹¬ç«‹æ•°æ®åº“ï¼ˆæ¯æœåŠ¡ä¸€ä¸ªæ•°æ®åº“ï¼‰
- âœ… å®‰è£…PostgreSQLæ‰©å±•ï¼ˆuuid-ossp, pg_trgm, pgcrypto, timescaledbï¼‰
- âœ… æˆäºˆæƒé™

---

## ğŸ“Š æ¶æ„äº®ç‚¹

### 1. å¾®æœåŠ¡åˆ’åˆ†

```
ä¼ä¸šçº§Agentå¹³å°
â”œâ”€â”€ Agent Service        - Agentæ ¸å¿ƒåŠŸèƒ½ï¼ˆæ¨ç†ã€è§„åˆ’ã€æ‰§è¡Œï¼‰
â”œâ”€â”€ Task Service         - ä»»åŠ¡é˜Ÿåˆ—å’Œè°ƒåº¦
â”œâ”€â”€ Tool Service         - å·¥å…·æ³¨å†Œå’Œæ‰§è¡Œ
â”œâ”€â”€ User Service         - ç”¨æˆ·ç®¡ç†å’Œè®¤è¯
â”œâ”€â”€ Tenant Service       - ç§Ÿæˆ·ç®¡ç†å’Œé…é¢
â”œâ”€â”€ Cost Service         - æˆæœ¬ç›‘æ§å’Œä¼˜åŒ–
â””â”€â”€ Monitoring Service   - ç›‘æ§å’Œå¥åº·æ£€æŸ¥
```

**è®¾è®¡åŸåˆ™**:
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
- æ•°æ®éš”ç¦»ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“
- æœåŠ¡è‡ªæ²»ï¼šç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹æ‰©å±•

### 2. é€šä¿¡æ¶æ„

**åŒæ­¥é€šä¿¡**: gRPC
- é«˜æ€§èƒ½ã€ç±»å‹å®‰å…¨
- æ”¯æŒæµå¼å“åº”ï¼ˆAgentæ‰§è¡Œä»»åŠ¡ï¼‰
- æœåŠ¡å‘ç°é›†æˆï¼ˆConsulï¼‰

**å¼‚æ­¥é€šä¿¡**: NATSæ¶ˆæ¯é˜Ÿåˆ—
- äº‹ä»¶é©±åŠ¨æ¶æ„
- è§£è€¦æœåŠ¡ä¾èµ–
- ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

### 3. æœåŠ¡å‘ç°

```
ConsulæœåŠ¡æ³¨å†Œä¸­å¿ƒ
â”œâ”€â”€ agent-service (3 instances)
â”œâ”€â”€ task-service (5 instances)
â”œâ”€â”€ tool-service (3 instances)
â”œâ”€â”€ user-service (2 instances)
â”œâ”€â”€ tenant-service (2 instances)
â”œâ”€â”€ cost-service (2 instances)
â””â”€â”€ monitoring-service (1 instance)

è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
- Round Robinï¼ˆè½®è¯¢ï¼‰
- Least Connectionsï¼ˆæœ€å°‘è¿æ¥ï¼‰
- Consistent Hashingï¼ˆä¸€è‡´æ€§å“ˆå¸Œï¼‰
```

### 4. æ•°æ®æ¶æ„

**Database per Serviceæ¨¡å¼**:
```
agent_db     â†’ Agentæ•°æ®ï¼ˆagents, contextsï¼‰
task_db      â†’ ä»»åŠ¡æ•°æ®ï¼ˆtasks, task_logsï¼‰
tool_db      â†’ å·¥å…·æ•°æ®ï¼ˆtools, executionsï¼‰
user_db      â†’ ç”¨æˆ·æ•°æ®ï¼ˆusers, rolesï¼‰
tenant_db    â†’ ç§Ÿæˆ·æ•°æ®ï¼ˆtenants, quotasï¼‰
cost_db      â†’ æˆæœ¬æ•°æ®ï¼ˆtoken_usage, time-seriesï¼‰
```

**ç¼“å­˜ç­–ç•¥**:
```
L1: Local Cache (in-memory)  â†’ 1min TTL
L2: Redis Cache              â†’ 5min TTL
L3: Database                 â†’ æŒä¹…åŒ–
```

### 5. å¯è§‚æµ‹æ€§ä¸‰æ”¯æŸ±

**ç›‘æ§ï¼ˆMetricsï¼‰**:
- Prometheusæ”¶é›†æŒ‡æ ‡
- Grafanaå¯è§†åŒ–é¢æ¿
- é»„é‡‘æŒ‡æ ‡ï¼šå»¶è¿Ÿã€æµé‡ã€é”™è¯¯ã€é¥±å’Œåº¦

**æ—¥å¿—ï¼ˆLoggingï¼‰**:
- ELK Stackï¼ˆElasticsearch + Logstash + Kibanaï¼‰
- ç»“æ„åŒ–JSONæ—¥å¿—
- é›†ä¸­åŒ–æ—¥å¿—æŸ¥è¯¢

**è¿½è¸ªï¼ˆTracingï¼‰**:
- Jaegeråˆ†å¸ƒå¼è¿½è¸ª
- è¯·æ±‚å…¨é“¾è·¯è·Ÿè¸ª
- æ€§èƒ½ç“¶é¢ˆåˆ†æ

### 6. éƒ¨ç½²æ¶æ„

**Kuberneteséƒ¨ç½²**:
```
agent-platform-prod (Namespace)
â”œâ”€â”€ Deployments (7ä¸ªæœåŠ¡ï¼Œå¤šå‰¯æœ¬)
â”œâ”€â”€ Services (ClusterIP)
â”œâ”€â”€ HPA (è‡ªåŠ¨æ‰©ç¼©å®¹)
â”œâ”€â”€ ConfigMaps (é…ç½®ç®¡ç†)
â”œâ”€â”€ Secrets (å¯†é’¥ç®¡ç†)
â””â”€â”€ Ingress (å¤–éƒ¨è®¿é—®)
```

**è‡ªåŠ¨æ‰©ç¼©å®¹**:
- åŸºäºCPUä½¿ç”¨ç‡ï¼ˆ70%è§¦å‘æ‰©å®¹ï¼‰
- min: 3 pods, max: 10 pods

---

## ğŸ¯ æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| APIå“åº”æ—¶é—´ï¼ˆP95ï¼‰ | < 200ms |
| Agentæ¨ç†å»¶è¿Ÿï¼ˆP95ï¼‰ | < 2s |
| ç³»ç»Ÿååé‡ | 10,000 QPS |
| å¹¶å‘Agentæ•° | 100,000 |
| å¯ç”¨æ€§ | 99.9% |

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Go | 1.21+ | æœåŠ¡å¼€å‘ |
| gRPC | 1.60+ | æœåŠ¡é€šä¿¡ |
| PostgreSQL | 15+ | æ•°æ®å­˜å‚¨ |
| Redis | 7+ | ç¼“å­˜ |
| Consul | 1.17+ | æœåŠ¡å‘ç° |
| NATS | 2.10+ | æ¶ˆæ¯é˜Ÿåˆ— |
| Prometheus | 2.48+ | ç›‘æ§ |
| Grafana | 10.2+ | å¯è§†åŒ– |
| Jaeger | 1.52+ | è¿½è¸ª |
| Elasticsearch | 8.11+ | æ—¥å¿—å­˜å‚¨ |
| Kubernetes | 1.28+ | å®¹å™¨ç¼–æ’ |
| Docker | 24+ | å®¹å™¨åŒ– |

---

## ğŸš€ ä¸‹ä¸€æ­¥

**Task 4.1.2 - å®ç°å¤šç§Ÿæˆ·ç³»ç»Ÿï¼ˆDay 3-5ï¼‰**:
- ç§Ÿæˆ·æ¨¡å‹è®¾è®¡
- æ•°æ®éš”ç¦»å®ç°
- èµ„æºé…é¢ç®¡ç†
- åŠŸèƒ½å¼€å…³ç³»ç»Ÿ

**Task 4.1.3 - å®ç°æƒé™ç®¡ç†ï¼ˆDay 6-8ï¼‰**:
- RBACæƒé™æ¨¡å‹ï¼ˆåŸºäºPhase 3çš„authæ¨¡å—ï¼‰
- APIæƒé™æ£€æŸ¥
- è·¨æœåŠ¡æƒé™ä¼ é€’
- æƒé™é…ç½®UI

**Task 4.1.4 - å®ç°æˆæœ¬æ§åˆ¶ï¼ˆDay 9-11ï¼‰**:
- Tokenä½¿ç”¨ç»Ÿè®¡
- æˆæœ¬è®¡ç®—å¼•æ“
- æˆæœ¬æŠ¥è¡¨ç”Ÿæˆ
- æˆæœ¬é¢„æµ‹åˆ†æ

---

## ğŸ“ æ–‡ä»¶æ¸…å•

```
architecture/
â”œâ”€â”€ proto/
â”‚   â”œâ”€â”€ agent.proto              âœ… AgentæœåŠ¡åè®®
â”‚   â”œâ”€â”€ task.proto               âœ… ä»»åŠ¡æœåŠ¡åè®®
â”‚   â””â”€â”€ tenant.proto             âœ… ç§Ÿæˆ·æœåŠ¡åè®®
â”œâ”€â”€ PROJECT_STRUCTURE.md         âœ… é¡¹ç›®ç»“æ„è¯´æ˜
â””â”€â”€ diagrams/                    ğŸ“ å¾…æ·»åŠ æ¶æ„å›¾

deploy/
â”œâ”€â”€ docker-compose/
â”‚   â”œâ”€â”€ docker-compose.dev.yml   âœ… å¼€å‘ç¯å¢ƒé…ç½®
â”‚   â””â”€â”€ init-db.sql              âœ… æ•°æ®åº“åˆå§‹åŒ–
â””â”€â”€ kubernetes/                  ğŸ“ å¾…å®ç°K8sé…ç½®

docs/architecture/
â””â”€â”€ microservices.md             âœ… å¾®æœåŠ¡æ¶æ„æ–‡æ¡£

Makefile                          âœ… æ„å»ºå’Œéƒ¨ç½²è„šæœ¬
```

---

**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: âœ… Task 4.1.1 å®Œæˆ
**è¾“å‡º**: æ¶æ„æ–‡æ¡£ã€gRPCåè®®ã€Docker Composeé…ç½®ã€Makefile

## ğŸ‰ Task 4.1.1 å¾®æœåŠ¡æ¶æ„è®¾è®¡å®Œæˆï¼

è®¾è®¡äº†å®Œæ•´çš„ç”Ÿäº§çº§Agentå¹³å°æ¶æ„ï¼š
- âœ… 7ä¸ªå¾®æœåŠ¡æ¨¡å—åŒ–è®¾è®¡
- âœ… gRPC + æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡
- âœ… ConsulæœåŠ¡å‘ç°
- âœ… å®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»
- âœ… ä¸€é”®å¯åŠ¨çš„å¼€å‘ç¯å¢ƒ
- âœ… Kubernetesç”Ÿäº§éƒ¨ç½²æ¶æ„

**å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å®ç°å„ä¸ªæœåŠ¡ï¼**
