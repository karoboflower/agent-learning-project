version: '3.8'

services:
  # === 分布式追踪系统 ===

  # Jaeger All-in-One
  jaeger:
    image: jaegertracing/all-in-one:1.51
    container_name: jaeger
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=elasticsearch
      - ES_SERVER_URLS=http://elasticsearch:9200
      - ES_INDEX_PREFIX=jaeger
      - ES_TAGS_AS_FIELDS_ALL=false
      - ES_NUM_SHARDS=5
      - ES_NUM_REPLICAS=1
      - METRICS_STORAGE_TYPE=prometheus
    ports:
      - "5775:5775/udp"   # agent zipkin.thrift compact
      - "6831:6831/udp"   # agent jaeger.thrift compact
      - "6832:6832/udp"   # agent jaeger.thrift binary
      - "5778:5778"       # agent configs
      - "16686:16686"     # UI
      - "14250:14250"     # collector gRPC
      - "14268:14268"     # collector HTTP
      - "14269:14269"     # admin port: health check, metrics
      - "9411:9411"       # Zipkin compatible endpoint
    volumes:
      - ./tracing/jaeger/jaeger-config.yml:/etc/jaeger/jaeger-config.yml:ro
      - ./tracing/jaeger/sampling-strategies.json:/etc/jaeger/sampling-strategies.json:ro
    networks:
      - monitoring
    restart: unless-stopped
    depends_on:
      - elasticsearch
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Zipkin（可选，作为Jaeger的替代）
  zipkin:
    image: openzipkin/zipkin:2.24
    container_name: zipkin
    environment:
      - STORAGE_TYPE=elasticsearch
      - ES_HOSTS=elasticsearch:9200
      - ES_INDEX=zipkin
      - JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9412:9411"      # HTTP
    networks:
      - monitoring
    restart: unless-stopped
    depends_on:
      - elasticsearch
    profiles:
      - zipkin

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.89.0
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yml"]
    volumes:
      - ./tracing/otel/otel-collector-config.yml:/etc/otel-collector-config.yml:ro
    ports:
      - "4317:4317"      # OTLP gRPC
      - "4318:4318"      # OTLP HTTP
      - "8888:8888"      # Prometheus metrics
      - "8889:8889"      # Prometheus exporter
      - "13133:13133"    # health check
    networks:
      - monitoring
    restart: unless-stopped
    depends_on:
      - jaeger
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Elasticsearch（用于存储追踪数据）
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: elasticsearch-tracing
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
    volumes:
      - elasticsearch_tracing_data:/usr/share/elasticsearch/data
    ports:
      - "9201:9200"
      - "9301:9300"
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Jaeger Spark Dependencies（依赖分析）
  jaeger-spark-dependencies:
    image: jaegertracing/spark-dependencies:latest
    container_name: jaeger-spark-dependencies
    environment:
      - STORAGE=elasticsearch
      - ES_NODES=http://elasticsearch:9200
      - ES_INDEX_PREFIX=jaeger
      - JAVA_OPTS=-Xms512m -Xmx512m
    networks:
      - monitoring
    restart: "no"
    depends_on:
      - elasticsearch
      - jaeger
    profiles:
      - dependencies

volumes:
  elasticsearch_tracing_data:

networks:
  monitoring:
    driver: bridge
