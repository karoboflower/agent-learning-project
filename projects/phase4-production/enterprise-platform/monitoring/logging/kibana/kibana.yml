# Kibana配置文件

server.name: kibana
server.host: "0.0.0.0"
server.port: 5601

# Elasticsearch配置
elasticsearch.hosts: ["http://elasticsearch:9200"]
# elasticsearch.username: "kibana_system"
# elasticsearch.password: "${KIBANA_PASSWORD}"

# Kibana索引
kibana.index: ".kibana"

# 监控
monitoring.enabled: true
monitoring.kibana.collection.enabled: true
monitoring.ui.enabled: true

# 日志
logging.dest: /var/log/kibana/kibana.log
logging.verbose: false
logging.quiet: false

# 国际化
i18n.locale: "zh-CN"

# Dashboard保存的对象

## 索引模式
# POST /api/saved_objects/index-pattern/app-logs-*
{
  "attributes": {
    "title": "app-logs-*",
    "timeFieldName": "@timestamp",
    "fields": "[...]",
    "fieldFormatMap": "{\"duration\":{\"id\":\"duration\",\"params\":{\"inputFormat\":\"milliseconds\"}}}"
  }
}

## 搜索保存
# POST /api/saved_objects/search/error-logs-search
{
  "attributes": {
    "title": "Error Logs",
    "description": "Search for error level logs",
    "columns": ["timestamp", "service", "level", "message", "error"],
    "sort": [["@timestamp", "desc"]],
    "kibanaSavedObjectMeta": {
      "searchSourceJSON": "{\"index\":\"app-logs-*\",\"query\":{\"query\":\"level:error OR level:fatal\",\"language\":\"lucene\"},\"filter\":[]}"
    }
  }
}

## 可视化 - 日志级别分布
# POST /api/saved_objects/visualization/log-level-distribution
{
  "attributes": {
    "title": "Log Level Distribution",
    "visState": "{\"type\":\"pie\",\"params\":{\"type\":\"pie\",\"addTooltip\":true,\"addLegend\":true,\"legendPosition\":\"right\"},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"level\",\"size\":5,\"order\":\"desc\",\"orderBy\":\"1\"}}]}",
    "kibanaSavedObjectMeta": {
      "searchSourceJSON": "{\"index\":\"app-logs-*\",\"query\":{\"query\":\"\",\"language\":\"lucene\"},\"filter\":[]}"
    }
  }
}

## 可视化 - 服务请求率
# POST /api/saved_objects/visualization/service-request-rate
{
  "attributes": {
    "title": "Service Request Rate",
    "visState": "{\"type\":\"line\",\"params\":{\"type\":\"line\",\"grid\":{\"categoryLines\":false},\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"type\":\"category\",\"position\":\"bottom\",\"show\":true,\"style\":{},\"scale\":{\"type\":\"linear\"},\"labels\":{\"show\":true,\"filter\":true,\"truncate\":100},\"title\":{}}],\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"name\":\"LeftAxis-1\",\"type\":\"value\",\"position\":\"left\",\"show\":true,\"style\":{},\"scale\":{\"type\":\"linear\",\"mode\":\"normal\"},\"labels\":{\"show\":true,\"rotate\":0,\"filter\":false,\"truncate\":100},\"title\":{\"text\":\"Count\"}}]},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"date_histogram\",\"schema\":\"segment\",\"params\":{\"field\":\"@timestamp\",\"interval\":\"auto\",\"min_doc_count\":1}},{\"id\":\"3\",\"enabled\":true,\"type\":\"terms\",\"schema\":\"group\",\"params\":{\"field\":\"service\",\"size\":10,\"order\":\"desc\",\"orderBy\":\"1\"}}]}",
    "kibanaSavedObjectMeta": {
      "searchSourceJSON": "{\"index\":\"app-logs-*\",\"query\":{\"query\":\"\",\"language\":\"lucene\"},\"filter\":[]}"
    }
  }
}

## 可视化 - 错误趋势
# POST /api/saved_objects/visualization/error-trend
{
  "attributes": {
    "title": "Error Trend",
    "visState": "{\"type\":\"area\",\"params\":{\"type\":\"area\",\"grid\":{\"categoryLines\":false},\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"type\":\"category\",\"position\":\"bottom\",\"show\":true}],\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"name\":\"LeftAxis-1\",\"type\":\"value\",\"position\":\"left\",\"show\":true}]},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"date_histogram\",\"schema\":\"segment\",\"params\":{\"field\":\"@timestamp\",\"interval\":\"auto\"}}]}",
    "kibanaSavedObjectMeta": {
      "searchSourceJSON": "{\"index\":\"app-logs-*\",\"query\":{\"query\":\"level:error OR level:fatal\",\"language\":\"lucene\"},\"filter\":[]}"
    }
  }
}

## Dashboard - 应用日志概览
# POST /api/saved_objects/dashboard/app-logs-overview
{
  "attributes": {
    "title": "Application Logs Overview",
    "description": "Overview of application logs including request rates, error trends, and service performance",
    "panelsJSON": "[{\"version\":\"7.10.0\",\"gridData\":{\"x\":0,\"y\":0,\"w\":12,\"h\":8,\"i\":\"1\"},\"panelIndex\":\"1\",\"embeddableConfig\":{},\"panelRefName\":\"panel_1\"},{\"version\":\"7.10.0\",\"gridData\":{\"x\":12,\"y\":0,\"w\":12,\"h\":8,\"i\":\"2\"},\"panelIndex\":\"2\",\"embeddableConfig\":{},\"panelRefName\":\"panel_2\"},{\"version\":\"7.10.0\",\"gridData\":{\"x\":0,\"y\":8,\"w\":24,\"h\":12,\"i\":\"3\"},\"panelIndex\":\"3\",\"embeddableConfig\":{},\"panelRefName\":\"panel_3\"}]",
    "optionsJSON": "{\"useMargins\":true,\"hidePanelTitles\":false}",
    "timeRestore": true,
    "timeTo": "now",
    "timeFrom": "now-24h",
    "refreshInterval": {
      "pause": false,
      "value": 30000
    }
  },
  "references": [
    {
      "name": "panel_1",
      "type": "visualization",
      "id": "log-level-distribution"
    },
    {
      "name": "panel_2",
      "type": "visualization",
      "id": "error-trend"
    },
    {
      "name": "panel_3",
      "type": "visualization",
      "id": "service-request-rate"
    }
  ]
}

## Watcher - 错误告警
# POST _watcher/watch/error-alert
{
  "trigger": {
    "schedule": {
      "interval": "5m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": ["app-logs-*"],
        "body": {
          "query": {
            "bool": {
              "must": [
                {
                  "terms": {
                    "level": ["error", "fatal"]
                  }
                },
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-5m"
                    }
                  }
                }
              ]
            }
          },
          "aggs": {
            "by_service": {
              "terms": {
                "field": "service",
                "size": 10
              }
            }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.hits.total.value": {
        "gt": 10
      }
    }
  },
  "actions": {
    "send_email": {
      "email": {
        "to": "ops-team@enterprise-platform.com",
        "subject": "High Error Rate Alert",
        "body": {
          "text": "Detected {{ctx.payload.hits.total.value}} errors in the last 5 minutes"
        }
      }
    },
    "webhook": {
      "webhook": {
        "scheme": "http",
        "host": "alerting-service",
        "port": 8080,
        "method": "post",
        "path": "/alerts/error-rate",
        "params": {},
        "headers": {
          "Content-Type": "application/json"
        },
        "body": "{\"alert\":\"high_error_rate\",\"count\":{{ctx.payload.hits.total.value}}}"
      }
    }
  }
}
